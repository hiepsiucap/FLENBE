# @format

name: Deploy FLENBE to EC2

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests (if any)
        run: npm test --if-present

      - name: Deploy to EC2
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Ensure application directory exists
            sudo mkdir -p /var/www/flenbe
            sudo chown $USER:$USER /var/www/flenbe
            cd /var/www/flenbe

            # Initialize git repository if needed
            if [ ! -d ".git" ]; then
              echo "Cloning repository for the first time..."
              git clone https://github.com/hiepsiucap/FLENBE.git .
            else
              echo "Pulling latest changes..."
              git fetch origin
              git reset --hard origin/main
            fi

            # Ensure critical files exist
            if [ ! -f "bin/www" ]; then
              echo "ERROR: bin/www not found!"
              ls -la
              exit 1
            fi

            # Make bin/www executable
            chmod +x bin/www

            # Clean install dependencies
            echo "Installing dependencies..."
            rm -rf node_modules package-lock.json
            npm ci --production

            # Create/update .env file with secrets
            cat > .env << 'EOF'
            # Database
            MONGODB=${{ secrets.MONGODB }}

            # JWT
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            JWT_LIFETIME=${{ secrets.JWT_LIFETIME }}
            JWT_REFRESH_LIFETIME=${{ secrets.JWT_REFRESH_LIFETIME }}

            # AWS Configuration
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_POLLY_VOICE_ID=${{ secrets.AWS_POLLY_VOICE_ID }}
            AWS_POLLY_ENGINE=${{ secrets.AWS_POLLY_ENGINE }}
            AWS_POLLY_OUTPUT_FORMAT=${{ secrets.AWS_POLLY_OUTPUT_FORMAT }}

            # OpenAI/ChatGPT
            GPT_KEY=${{ secrets.GPT_KEY }}

            # Unsplash API for FlashCard images
            ACCESS_KEY_FLASHCARD=${{ secrets.ACCESS_KEY_FLASHCARD }}

            # Cloudinary
            CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
            CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
            CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}

            # Email Configuration
            EMAIL_USER=${{ secrets.EMAIL_USER }}
            EMAIL_PASS=${{ secrets.EMAIL_PASS }}

            # Application
            PORT=${{ secrets.PORT }}
            FRONT_END_API=${{ secrets.FRONT_END_API }}
            EOF

            # Stop existing PM2 process if running
            pm2 stop flenbe 2>/dev/null || true
            pm2 delete flenbe 2>/dev/null || true

            # Start the application using PM2
            echo "Starting application with PM2..."
            pm2 start bin/www --name flenbe

            # Wait for app to start
            sleep 3

            # Verify app is running
            if pm2 describe flenbe > /dev/null 2>&1; then
              echo "✅ Application started successfully!"
              pm2 save
              pm2 status
            else
              echo "❌ Failed to start application!"
              pm2 logs flenbe --lines 20
              exit 1
            fi
